<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Login</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        #auth-container {
            margin-top: 50px;
        }
        input, button {
            padding: 10px;
            margin: 10px;
        }
        .rw-conversation-container .rw-header { background-color: hsl(250, 69%, 61%); }
        .rw-conversation-container .rw-messages-container .rw-message .rw-client { background-color: hsl(250, 69%, 61%); }
        .rw-launcher { background-color: hsl(250, 69%, 61%); }
        .rw-conversation-container .rw-reply { background-color: hsl(250, 69%, 61%); border: 1px solid hsl(250, 69%, 61%); }
    </style>
</head>
<body>

    <!-- Authentication Form -->
    <div id="auth-container">
        <h2>Login to Chat</h2>
        <input type="email" id="login-email" placeholder="Email" required>
        <input type="password" id="login-password" placeholder="Password" required>
        <button onclick="login()">Login</button>
        <p id="login-error" style="color: red; display: none;">Invalid email!</p>
        <p>Don't have an account? <a href="#" onclick="toggleForms()">Register</a></p>
    </div>

    <div id="register-form" class="form-container" style="display: none;">
        <h2>Register</h2>
        <input type="email" id="register-email" placeholder="Email" required>
        <select id="role" onchange="toggleRoleFields()">
            <option value="">Select Role</option>
            <option value="student">Student</option>
            <option value="teacher">Teacher</option>
        </select>

        <div id="student-fields" style="display: none;">
            <input type="text" id="up_id" placeholder="UP ID">
            <input type="text" id="course" placeholder="Course">
            <input type="text" id="year" placeholder="Year">
        </div>

        <div id="teacher-fields" style="display: none;">
            <label>Select Courses:</label><br>
            <input type="checkbox" name="courses" value="Math"> Math<br>
            <input type="checkbox" name="courses" value="Physics"> Physics<br>
            <input type="checkbox" name="courses" value="Computer Science"> Computer Science<br>
        </div>

        <input type="password" id="register-password" placeholder="Password" required>
        <button onclick="register()">Register</button>
        <p>Already have an account? <a href="#" onclick="toggleForms()">Login</a></p>
    </div>

    <!-- Chat Container (Hidden initially) -->
    <div id="chat-container" style="display: none;">
        <h2>Chatbot</h2>
        <div id="rasa-chat-widget"></div>
    </div>

    <script>

        function login() {

            const userId = document.getElementById("login-email").value.trim();

            if (!userId) {
                console.error("User ID is empty! Cannot proceed.");
                return;
            }

            console.log("Logging in with User ID:", userId);

            const data = {
                email: document.getElementById("login-email").value,
                password: document.getElementById("login-password").value
            };

            fetch("/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }).then(response => response.json())
            .then(data => {
                if (data.token) {
                    localStorage.setItem("token", data.token);
                    localStorage.setItem("user_id", data.email);
                    //showChat();
                    document.getElementById("auth-container").style.display = "none";
                    document.getElementById("chat-container").style.display = "block";
                    loadChatWidget(userId);
                } else {
                    alert("Invalid credentials");
                }
            });
        }

        function logout() {
            localStorage.removeItem("token");
            document.getElementById("auth-container").style.display = "block";
            document.getElementById("chat-container").style.display = "none";
        }

        function loadChatWidget(userId) {
            !(function () {
                let e = document.createElement("script"),
                    t = document.head || document.getElementsByTagName("head")[0];
                (e.src = "https://cdn.jsdelivr.net/npm/rasa-webchat/lib/index.js"),
                (e.async = true),
                (e.onload = () => {
                    window.WebChat.default(
                        {
                            customData: { user_id: userId },  // Pass user_id to Rasa
                            socketUrl: "http://localhost:5005/",
                            title: 'Rasa bot',
                            subtitle: 'Say hi and get started!',
                            profileAvatar: "./assets/svg/robot.svg",
                            openLauncherImage: "./assets/svg/comment.svg",
                            closeImage: "./assets/svg/down.svg",
                            showMessageDate: true,
                            inputTextFieldHint: "What's on your mind?...",
                            embedded: true,
                            customMessageDelay: (message) => {
                                let delay = message.length * 40;
                                if (delay > 3000) delay = 3000;
                                if (delay < 800) delay = 800;
                                return delay;
                            }
                        },
                        null
                    );

                    // Send user ID to Rasa via Custom Channel
                    fetch("http://localhost:5005/webhooks/first/webhook", {
                        mode: "no-cors",
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body:{
                            "sender": "test_user",//userId,
                            "text": "Hi there!",
                            "metadata": {}//{ user_id: userId }  // Send metadata properly
                        }
                    })
                    .then(response => {
                        console.log("HTTP Status:", response.status);  // Debugging response status
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("User ID slot set in Rasa:", data);
                    })
                    .catch(error => console.error("Error setting user ID slot:", error));
                }),
                t.insertBefore(e, t.firstChild);
            })();
        }

    </script>

</body>
</html>
